// Redis package tests
// Tests RESP protocol encoding/parsing (no Redis server needed)
// If Redis is running on localhost:6379, also tests live operations

fn resp_cmd1(cmd: string) -> string {
    return "*1\r\n$" + int_to_string(cmd.len()) + "\r\n" + cmd + "\r\n"
}
fn resp_cmd2(cmd: string, arg1: string) -> string {
    return "*2\r\n$" + int_to_string(cmd.len()) + "\r\n" + cmd + "\r\n$" + int_to_string(arg1.len()) + "\r\n" + arg1 + "\r\n"
}
fn resp_cmd3(cmd: string, arg1: string, arg2: string) -> string {
    return "*3\r\n$" + int_to_string(cmd.len()) + "\r\n" + cmd + "\r\n$" + int_to_string(arg1.len()) + "\r\n" + arg1 + "\r\n$" + int_to_string(arg2.len()) + "\r\n" + arg2 + "\r\n"
}
fn resp_parse(raw: string) -> string {
    if raw.len() == 0 { return "" }
    var first = raw[0]
    if first == "+" { return raw.substring(1, raw.len() - 2) }
    if first == "-" { return raw.substring(1, raw.len() - 2) }
    if first == ":" { return raw.substring(1, raw.len() - 2) }
    if first == "$" {
        if raw[1] == "-" { return "" }
        var i = 1
        while i < raw.len() && raw[i] != "\r" { i += 1 }
        var start = i + 2
        var end = start
        while end < raw.len() && raw[end] != "\r" { end += 1 }
        return raw.substring(start, end)
    }
    return raw
}

fn main() -> int {
    Test.init("Redis Package")

    // RESP encoding
    Test.assert_eq_str(resp_cmd1("PING"), "*1\r\n$4\r\nPING\r\n", "encode PING")
    Test.assert_eq_str(resp_cmd2("GET", "key"), "*2\r\n$3\r\nGET\r\n$3\r\nkey\r\n", "encode GET")
    Test.assert_eq_str(resp_cmd3("SET", "k", "v"), "*3\r\n$3\r\nSET\r\n$1\r\nk\r\n$1\r\nv\r\n", "encode SET")

    // RESP parsing
    Test.assert_eq_str(resp_parse("+OK\r\n"), "OK", "parse +OK")
    Test.assert_eq_str(resp_parse(":42\r\n"), "42", "parse :42")
    Test.assert_eq_str(resp_parse("-ERR unknown\r\n"), "ERR unknown", "parse error")
    Test.assert_eq_str(resp_parse("$5\r\nhello\r\n"), "hello", "parse bulk string")
    Test.assert_eq_str(resp_parse("$-1\r\n"), "", "parse nil")
    Test.assert_eq_str(resp_parse(""), "", "parse empty")

    // Live test (only if Redis is running)
    var conn = Net.connect("localhost", 6379)
    if conn > 0 {
        Net.send(conn, resp_cmd1("PING"))
        var pong = resp_parse(Net.recv(conn))
        Test.assert_eq_str(pong, "PONG", "live PING")

        Net.send(conn, resp_cmd3("SET", "wyn_test_key", "wyn_test_val"))
        resp_parse(Net.recv(conn))

        Net.send(conn, resp_cmd2("GET", "wyn_test_key"))
        var val = resp_parse(Net.recv(conn))
        Test.assert_eq_str(val, "wyn_test_val", "live GET")

        Net.send(conn, resp_cmd2("DEL", "wyn_test_key"))
        Net.recv(conn)
        Net.close(conn)
    }

    Test.summary()
    return 0
}
